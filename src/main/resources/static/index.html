<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        #output {
            overflow: auto;
        }
        #output > p {
            overflow-wrap: break-word;
        }
        #output span {
            color: blue;
        }
        #output span.error {
            color: red;
        }
    </style>
    <script>
        function get(name){
            if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
                return decodeURIComponent(name[1]);
        }

        const wsUri = 'ws://localhost:8082';
        var scanbutton, sendbutton, cropbutton, restorebutton,
            output, websocket,
            image, data,
            resolutionSelect, colorSelect, openPaintCheckBox,
            docinfo, cropper, canvas, ctx;

        function init() {
            websocket = new WebSocket(wsUri);
            docinfo = get('docinfo');
            console.log(docinfo);
            scanbutton = document.querySelector('#scanbutton');
            sendbutton = document.querySelector('#sendbutton');
            cropbutton = document.querySelector('#cropbutton');
            restorebutton = document.querySelector('#restorebutton');
            output = document.querySelector('#output');
            openPaintCheckBox = document.querySelector('#openPaintCheckBox');
            image = new Image();
            canvas = document.querySelector('#canvas')
            ctx = canvas.getContext("2d");

            image.addEventListener("load", (e) => {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);
                cropper = new Cropper(canvas);
            });

            scanbutton.addEventListener('click', scanButtonOnClick);
            sendbutton.addEventListener('click', sendButtonOnClick);
            cropbutton.addEventListener('click', cropButtonOnClick);
            restorebutton.addEventListener('click', restoreButtonClick);
            resolutionSelect = document.querySelector('#resolution');
            colorSelect = document.querySelector('#color_mode');

            websocket.onopen = function (e) {
                writeToScreen('CONNECTED');
            };

            websocket.onclose = function (e) {
                writeToScreen('DISCONNECTED');
            };

            websocket.onmessage = function (e) {
                if (e.data instanceof Blob) {
                    var reader = new FileReader();
                    reader.addEventListener('loadend', () => {
                        data = reader.result;
                        image.src = data;
                    });
                    reader.readAsDataURL(e.data);
                } else {
                    writeToScreen('<span>RESPONSE: ' + e.data + '</span>');
                }
            };

            websocket.onerror = function (e) {
                writeToScreen('<span class=error>ERROR:</span> ' + e.data);
            };
        }
        function doSend(message) {
            writeToScreen('SENT: ' + message);
            websocket.send(message);
        }

        function writeToScreen(message) {
            output.insertAdjacentHTML(
                'afterbegin',
                '<p>' + message + '</p>',
            );
        }

        function scanButtonOnClick() {
            var resolution = resolutionSelect.value;
            var color_mode = colorSelect.value;
            var action = {action:'scan',color_mode:Number.parseInt(color_mode),resolution:Number.parseInt(resolution)}
            doSend(JSON.stringify(action));
        }

        function cropButtonOnClick() {
            var croppedCanvas = cropper.getCroppedCanvas();
            croppedCanvas.setAttribute('id','canvas');
            canvas = croppedCanvas;
            ctx = canvas.getContext('2d');
            $("#canvaswrapper").html(croppedCanvas);
            cropper = new Cropper(canvas);
        }

        function restoreButtonClick() {
            cropper.destroy();
            image.src = data;
            canvas.width = image.width;
            canvas.height = image.height;
        }

        function sendButtonOnClick() {
            if (data) {
                canvas.toBlob((blob) => {
                    sendImageAsPostRequest(
                        blob,
                        'image/png',
                        '/api/file/uploadimage',
                    );
                });
            } else {
                alert('Nincs beolvasott elmenthető kép!')
            }
        }

        async function sendImageAsPostRequest(imageBlob, mimeType, url) {
            const formData = new FormData();
            formData.append('file',imageBlob,'scanned.png');
            formData.append('docid', JSON.parse(docinfo).id);
            formData.append('openPaint', openPaintCheckBox.checked);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    console.log('Image uploaded successfully');
                    window.close();
                } else {
                    console.error('Error uploading image:', response.status);
                    alert("Error uploading image:" + response.status);
                }
            } catch (e) {
                console.log(e);
            }
        }
    </script>
    <script src="/cropper.js"></script>
    <script src="/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="/cropper.css"/>
</head>
<body onload="init()">
    <h2>WebSocket Test</h2>
    <label for="resolution">Felbontás:</label>
    <select name="resolution" id="resolution">
        <option value="150">150</option>
        <option value="300">300</option>
    </select>
    <label for="color_mode">Szín séma:</label>
    <select name="color_mode" id="color_mode">
        <option value="1">Color</option>
        <option value="2" selected>Grayscale</option>
        <option value="4">Black & White</option>
    </select>
    <label for="openPaintCheckBox">Paint megnyitása:</label>
    <input type="checkbox" id="openPaintCheckBox"/>
    <br/>
    <button id="scanbutton">Belovasás</button>
    <button id="sendbutton">Mentés</button>
    <button id="cropbutton">Vágás</button>
    <button id="restorebutton">Visszaállít</button>
    <div id="output"></div>
    <div id="cert"></div>
    <div id="canvaswrapper">
        <canvas id="canvas"/>
    </div>
</body>
</html>
