<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" crossorigin="anonymous">
    <style>
        .body {
            background-color: #8bb9fe;
        }
        #output {
            overflow: auto;
        }
        #output > p {
            overflow-wrap: break-word;
        }
        #output span {
            color: blue;
        }
        #output span.error {
            color: red;
        }

        .fa {
            -moz-osx-font-smoothing:grayscale;
            -webkit-font-smoothing:antialiased;
            display:inline-block;
            font-style:normal;
            font-variant:normal;
            text-rendering:auto;
            line-height:1
        }
        .fa-crop-alt:before {
            content:"\f565";
        }

        .fa-upload:before {
            content:"\f093"
        }

        .fa-sync-alt:before {
            content:"\f2f1"
        }

        .fa-scan:before {
            content:"\f1c5"
        }

        .docs-tooltip {
            display: block;
            margin: -0.5rem -0.75rem;
            padding: 0.5rem 0.75rem;
        }

        .controlpanel {
            background-color: #6c757d;
            padding: 10px;
        }
    </style>
    <script>
        function get(name){
            if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
                return decodeURIComponent(name[1]);
        }

        const wsUri = 'ws://localhost:8082';
        var scanbutton, sendbutton, cropbutton, restorebutton,
            output, websocket,
            image, data,
            resolutionSelect, colorSelect, openPaintCheckBox,
            docinfo, cropper, canvas, ctx;

        function init() {
            websocket = new WebSocket(wsUri);
            docinfo = get('docinfo');
            console.log(docinfo);
            scanbutton = document.querySelector('#scanbutton');
            sendbutton = document.querySelector('#sendbutton');
            cropbutton = document.querySelector('#cropbutton');
            restorebutton = document.querySelector('#restorebutton');
            output = document.querySelector('#output');
            openPaintCheckBox = document.querySelector('#openPaintCheckBox');
            image = new Image();
            canvas = document.querySelector('#canvas')
            ctx = canvas.getContext("2d");

            image.addEventListener("load", (e) => {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);
                cropper = new Cropper(canvas);
            });

            scanbutton.addEventListener('click', scanButtonOnClick);
            sendbutton.addEventListener('click', sendButtonOnClick);
            cropbutton.addEventListener('click', cropButtonOnClick);
            restorebutton.addEventListener('click', restoreButtonClick);
            resolutionSelect = document.querySelector('#resolution');
            colorSelect = document.querySelector('#color_mode');

            websocket.onopen = function (e) {
                writeToScreen('CONNECTED');
            };

            websocket.onclose = function (e) {
                writeToScreen('DISCONNECTED');
            };

            websocket.onmessage = function (e) {
                if (e.data instanceof Blob) {
                    var reader = new FileReader();
                    reader.addEventListener('loadend', () => {
                        data = reader.result;
                        image.src = data;
                    });
                    reader.readAsDataURL(e.data);
                } else {
                    writeToScreen('<span>RESPONSE: ' + e.data + '</span>');
                }
            };

            websocket.onerror = function (e) {
                writeToScreen('<span class=error>ERROR:</span> ' + e.data);
            };
        }
        function doSend(message) {
            writeToScreen('SENT: ' + message);
            websocket.send(message);
        }

        function writeToScreen(message) {
            output.insertAdjacentHTML(
                'afterbegin',
                '<p>' + message + '</p>',
            );
        }

        function scanButtonOnClick() {
            var resolution = resolutionSelect.value;
            var color_mode = colorSelect.value;
            var action = {action:'scan',color_mode:Number.parseInt(color_mode),resolution:Number.parseInt(resolution)}
            doSend(JSON.stringify(action));
        }

        function cropButtonOnClick() {
            if (cropper) {
                var croppedCanvas = cropper.getCroppedCanvas();
                croppedCanvas.setAttribute('id', 'canvas');
                canvas = croppedCanvas;
                ctx = canvas.getContext('2d');
                $("#canvaswrapper").html(croppedCanvas);
                cropper = new Cropper(canvas);
            }
        }

        function restoreButtonClick() {
            if (cropper) {
                cropper.destroy();
                image.src = data;
                canvas.width = image.width;
                canvas.height = image.height;
            }
        }

        function sendButtonOnClick() {
            if (data) {
                canvas.toBlob((blob) => {
                    sendImageAsPostRequest(
                        blob,
                        'image/png',
                        '/api/file/uploadimage',
                    );
                });
            } else {
                alert('Nincs beolvasott elmenthető kép!')
            }
        }

        async function sendImageAsPostRequest(imageBlob, mimeType, url) {
            const formData = new FormData();
            formData.append('file',imageBlob,'scanned.png');
            formData.append('docid', JSON.parse(docinfo).id);
            formData.append('openPaint', openPaintCheckBox.checked);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    console.log('Image uploaded successfully');
                    window.close();
                } else {
                    console.error('Error uploading image:', response.status);
                    alert("Error uploading image:" + response.status);
                }
            } catch (e) {
                console.log(e);
            }
        }
    </script>
    <script src="/cropper.js"></script>
    <script src="/bootstrap.bundle.js"></script>
    <script src="/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="/cropper.css"/>
    <link rel="stylesheet" href="/bootstrap.css"/>
</head>
<body onload="init()" class="body">
    <h2>Image scanner</h2>
    <label for="resolution">Felbontás:</label>
    <select name="resolution" id="resolution" class="form-select" style="width: 20%;">
        <option value="150">150</option>
        <option value="300">300</option>
    </select>
    <label for="color_mode">Szín séma:</label>
    <select name="color_mode" id="color_mode" class="form-select" style="width: 20%;">
        <option value="1">Color</option>
        <option value="2" selected>Grayscale</option>
        <option value="4">Black & White</option>
    </select>
    <div class="form-check">
        <label for="openPaintCheckBox" class="form-check-label">Paint megnyitása:</label>
        <input type="checkbox" id="openPaintCheckBox" class="form-check-input"/>
    </div>
    <br/>
    <div class="controlpanel">
        <button id="scanbutton" class="btn btn-primary">
            <span class="docs-tooltip" data-toggle="tooltip" title="Beolvasás">
                <span class="fa fa-scan"></span>
            </span>
        </button>
        <button id="sendbutton" class="btn btn-primary">
            <span class="docs-tooltip" data-toggle="tooltip" title="Feltöltés">
                <span class="fa fa-upload"></span>
            </span>
        </button>
        <button id="cropbutton" class="btn btn-primary">
            <span class="docs-tooltip" data-toggle="tooltip" title="Vágás">
                <span class="fa fa-crop-alt"></span>
            </span>
        </button>
        <button id="restorebutton" class="btn btn-primary">
            <span class="docs-tooltip" data-toggle="tooltip" title="Visszaállítás">
                <span class="fa fa-sync-alt"></span>
            </span>
        </button>
    </div>
    <div id="output"></div>
    <div id="cert"></div>
    <div id="canvaswrapper">
        <canvas id="canvas"/>
    </div>
</body>
</html>
